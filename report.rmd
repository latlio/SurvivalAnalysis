---
title: "Survival Analysis Project: Preliminary EDA"
author: "Madison Hobbs & Lathan Liou"
class: "MATH150: Methods in Biostatistics"
date: "4/2/2019"
output: pdf_document
---

```{r setup, include=FALSE, fig.height=3}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GGally)
library("survival")
library(survminer)
library(broom)
library(pec)
aids <- read_csv("AIDSdata.csv")
```

# Introduction

Our project seeks to understand time of survival until an AIDS defining event or death. In the first phase of our project, we want to understand the distributions of our time-to-event variables and the remaining explanatory variables. Further, we are curious to see whether there exists correlated relationships between any of our explanatory variables. This will be important during our modeling phase when we have to consider whether to include correlated variables or not.

# Exploratory Data Analysis

## A Note About Treatments

According to the variable information table, we note that `txgrp` could have four levels (1: ZDV + 3TC, 2: ZDV + 3TC + IDV, 3: d4T + 3TC, and 4: d4T + 3TC + IDV). However, this dataset contains only two levels of `txgrp` (1: ZDV + 3TC, 2: ZDV + 3TC + IDV), as shown below:

```{r}
aids %>% group_by(txgrp) %>% summarise(n())
```

In fact, since the variable `tx` is supposed to indicate whether the treatment contained IDV, we might assume that `txgrp` and `tx` are redundant information in this dataset and that a 1 in `txgrp` is equivalent to a 0 in `tx` while a 2 in `txgrp` is equivalent to a 1 in `tx`. We confirm this hunch below. 

The following code says: create a new dataframe by taking all the rows in `data` where `txgrp` is 1 and `tx` is 0 *or* `txgrp` is 2 and `tx` is 1. Now, make sure that new dataframe is identical to the original data frame, and return `TRUE` if this is indeed the case. 


```{r}
# Is it true that for every entry in `aids`
all(
  (aids %>% 
     filter(((txgrp == 1 && tx == 0) || (txgrp == 2 && tx == 1)))) 
  == aids
) == TRUE
```

## Correlation

We present a pairs plot of our explanatory variables, excluding id, our time-to-event variables, and our censoring variables to 1) visualize the distribution of the variables and 2) identify potential pair-wise correlation. \texttt{cd4} and \texttt{strat2} have a correlation coefficient of 0.74, which indicates moderate to strong correlation. This makes sense since \texttt{strat2} is the indicator variable for the continuous variable, \texttt{cd4}. Additionally, as noted just above, \texttt{tx} and \texttt{txgrp} provide the exact same information and therefore are perfectly correlated. Lastly, we would like to note that \texttt{sex}, \texttt{ivdrug}, and \texttt{hemophil} are highly unbalanced variables, meaning that one level of the variables is disproportionately represented relative to the other level(s).

```{r, fig.height=8, fig.width=13}
aids %>%
  select(tx:age) %>%
  ggpairs()
```

## Censored vs. Non-Censored

It's worth noting that there are, in fact, two censored time-to-event variables. The primary variable of interest is `time` which is time in days to AIDs diagnosis or death, and this is informed by `censor`, which is 1 (true) if an individual was either diagnosed with AIDS *or* died during the course of the study and 0 otherwise. The other censored variable is `time_d` which is the time in days to death alone, governed by `censor_d` which is 1 if the person died during the study and 0 if not. 

Since the primary variable of interest is time to AIDs diagnosis or death, we examine the complete (non-censored) individuals - those who were either diagnosed with AIDS *or* who died over the course of the study. The only caveat is that there are only 69 such individuals out of a study of 851 - most of the participants did not die or get diagnosed before the study's end. 

```{r}
non_censored <- aids %>% filter(censor == 1) %>% 
  mutate(tx=ifelse(tx == 0, "Control", "IDV"))
dim(non_censored) # complete AIDS or death
dim(aids)         # everyone
```

Among those with complete times, we notice from the side-by-side histograms below that both the control and IDV groups are skewed right. This makes sense - for complete observations, it's probably less common for people to last a long time without being diagnosed or dying. The distributions between the control and IDV groups don't look that different however, especially given the tiny sample sizes.

```{r}
ggplot(non_censored, aes(x = time)) + geom_histogram(bins = 30) + facet_grid(.~tx) + ggtitle("Complete Observations: Treatment vs. Time to Event") + xlab("Time until AIDS Diagnosis or Death")
```
 
When looking at the censored (incomplete) times for diagnosis/death, both control and IDV groups are in the opposite direction (left).

```{r}
ggplot(aids %>% filter(censor == 0) %>% mutate(tx=ifelse(tx == 0, "Control", "IDV")), aes(x = time_d)) + geom_histogram(bins = 20) + facet_grid(.~tx) + ggtitle("Incomplete Observations: Treatment vs. Time to Event") + xlab("Time until End of Study")
```

## Prior ZDV on Complete Observations

We were also curious about the relationship between time to diagnosis/death and number of months of prior ZDV use for non-censored participants. Interestingly, there appeared to be no relationship whatsoever, as evidenced by the following scatterplot:

```{r}
ggplot(non_censored, aes(x = time, y= priorzdv)) + 
  geom_point() + 
  ggtitle("# Months Prior ZDV Treatment vs. Time to Death/Diagnosis")
```

This finding is made even clearer when we log the number of months of prior zdv:

```{r}
ggplot(non_censored, aes(x = time, y= log(priorzdv))) + 
  geom_point() + 
  ggtitle("Log of # Months Prior ZDV Treatment vs. Time to Death/Diagnosis")
```

# Cox PH model

```{r}
modeling_data <- aids %>% 
  select(-id, -time_d, -censor_d)
coxph(Surv(time,censor) ~ tx, data = aids) %>% tidy()
ggsurvplot(survfit(Surv(time,censor) ~ tx, data=aids),censor=T, conf.int=T) + ggtitle("By Treatment")
```

## Backward Variable Selection 

Make sure all the variables we are putting into backward selection are not in violation of the proportional hazards assumptions. Happily, none of the variables are in violation since no p-value is under 0.05.

```{r}
cox.zph(coxph(Surv(time,censor) ~ tx+strat2+sex+raceth+ivdrug+hemophil+karnof+cd4+priorzdv+age, data=aids))
```


```{r}
f_aic <- selectCox(Surv(time,censor)~tx+strat2+sex+raceth+ivdrug+hemophil+karnof+cd4+priorzdv+age, data=aids, rule="aic")
f_aic
cox.zph(coxph(Surv(time,censor) ~ karnof+cd4, data=aids))
```

```{r}
f_p <- selectCox(Surv(time,censor)~tx+strat2+sex+raceth+ivdrug+hemophil+karnof+cd4+priorzdv+age, data=aids, rule="p")
f_p
cox.zph(coxph(Surv(time,censor) ~ karnof+cd4, data=aids))
```

